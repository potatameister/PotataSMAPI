name: Build PotataSMAPI Native APK

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Set up .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    # 1. Build SMAPI Core (C#)
    - name: Generate Dummy References
      run: |
        cd smapi-engine
        dotnet new classlib -n DummyRefs -o DummyRefs
        echo 'namespace StardewValley { public class Game1 { public static string version = "1.6.14"; } }' > DummyRefs/Class1.cs
        echo 'namespace StardewValley.GameData { public class Dummy {} }' >> DummyRefs/Class1.cs
        echo 'namespace Microsoft.Xna.Framework { public class Vector2 { public float X; public float Y; } }' >> DummyRefs/Class1.cs
        dotnet build DummyRefs -c Release
        cp DummyRefs/bin/Release/*/DummyRefs.dll "Stardew Valley.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "StardewValley.GameData.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "BmFont.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "GalaxyCSharp.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "Lidgren.Network.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "MonoGame.Framework.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "SkiaSharp.dll"
        cp DummyRefs/bin/Release/*/DummyRefs.dll "xTile.dll"
        cd ..

    - name: Build SMAPI Core
      run: |
        dotnet build smapi-engine/src/SMAPI/SMAPI.csproj --configuration Release -p:GamePath="." -p:CopyToGameFolder="false"
        mkdir -p android/app/src/main/assets
        cp smapi-engine/src/SMAPI/bin/Release/net6.0/StardewModdingAPI.dll android/app/src/main/assets/

    # 2. Build Android APK
    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Build Android APK
      run: |
        cd android
        chmod +x gradlew
        ./gradlew assembleDebug

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: PotataSMAPI-Native-APK
        path: android/app/build/outputs/apk/debug/app-debug.apk
